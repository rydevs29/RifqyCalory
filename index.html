<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RifqyKalori</title>
  <link rel="manifest" href="data:application/manifest+json,{\"name\":\"RifqyKalori\",\"short_name\":\"Kalori\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#0f0c29\",\"theme_color\":\"#6c5ce7\",\"icons\":[{\"src\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==\",\"sizes\":\"192x192\"}]}">
  <meta name="theme-color" content="#6c5ce7">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #6c5ce7; --secondary: #8f94fb; --bg: #0f0c29; --glass: rgba(255,255,255,0.1); --text: #ffffff; --radius: 28px; --shadow: 0 20px 40px rgba(0,0,0,0.3); --gap: 16px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); color: var(--text); min-height: 100vh; padding-bottom: 90px; }
    .container { max-width: 900px; margin: 0 auto; padding: var(--gap); }
    .header { text-align: center; margin-bottom: 16px; }
    h1 { font-size: clamp(28px, 5vw, 38px); background: linear-gradient(to right, #6c5ce7, #8f94fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { font-size: clamp(14px, 3.5vw, 17px); opacity: 0.9; }
    .card { backdrop-filter: blur(16px); background: var(--glass); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: var(--gap); }
    .camera-container { position: relative; height: 300px; border-radius: 20px; overflow: hidden; margin-bottom: 16px; background: #000; }
    #video, #preview { width: 100%; height: 100%; object-fit: cover; } #canvas { display: none; }
    .btn { width: 100%; padding: 14px; font-size: 15px; font-weight: 600; border: none; border-radius: 18px; cursor: pointer; margin: 8px 0; }
    .btn-camera { background: #51cf66; color: white; } .btn-scan { background: var(--secondary); color: white; } .btn-save { background: #ffd43b; color: #333; } .btn-upload { background: #feca57; color: #333; }
    .result { margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 16px; text-align: center; }
    .result h3 { margin-bottom: 8px; font-size: 18px; } .gizi { display: flex; justify-content: space-around; margin: 12px 0; font-size: 14px; }
    .chart-container { height: 180px; margin: 16px 0; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass); backdrop-filter: blur(16px); border-top: 1px solid rgba(255,255,255,0.2); display: flex; padding: 10px 12px; z-index: 1000; }
    .nav-item { flex: 1; text-align: center; padding: 10px 6px; font-size: 13px; font-weight: 600; border-radius: 18px; margin: 0 6px; transition: all 0.3s; cursor: pointer; }
    .nav-item.active { background: var(--secondary); color: white; } .hidden { display: none; }
    .history-list { display: grid; gap: 12px; } .history-item { background: rgba(255,255,255,0.1); padding: 14px; border-radius: 16px; font-size: 14px; } .history-item small { opacity: 0.7; }
    input[type="file"] { display: none; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>RifqyKalori</h1>
      <p class="subtitle">Foto atau Upload → Kalori + Gizi otomatis!</p>
    </div>

    <!-- HOME -->
    <div id="tab-home" class="tab-content">
      <div class="card">
        <div class="camera-container">
          <video id="video" autoplay playsinline class="hidden"></video>
          <img id="preview" src="" class="hidden">
          <canvas id="canvas"></canvas>
        </div>

        <label class="btn btn-upload">
          Upload Foto <input type="file" id="fileInput" accept="image/*">
        </label>
        <button class="btn btn-camera" onclick="startCamera()">Buka Kamera</button>
        <button class="btn btn-scan" onclick="scanImage()">Scan Makanan</button>

        <div id="result" class="result hidden">
          <h3 id="food-name">Nasi Goreng</h3>
          <div class="gizi">
            <div><strong id="calories">450</strong> kcal</div>
            <div>Karbo: <strong id="carb">65g</strong></div>
            <div>Prot: <strong id="protein">12g</strong></div>
            <div>Lemak: <strong id="fat">18g</strong></div>
          </div>
          <div class="chart-container"><canvas id="giziChart"></canvas></div>
          <button class="btn btn-save" onclick="saveFood()">Simpan ke Riwayat</button>
        </div>
      </div>
    </div>

    <!-- RIWAYAT -->
    <div id="tab-riwayat" class="tab-content hidden">
      <div class="card">
        <h3>Riwayat Makan</h3>
        <div id="history-list" class="history-list"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home')">Home</div>
    <div class="nav-item" onclick="switchTab('riwayat')">Riwayat</div>
    <div class="nav-item" onclick="alert('RifqyKalori v2.0\n300+ Makanan & Minuman\nDibuat oleh Rifqy © 2025')">About</div>
  </div>

  <script src="db.js"></script>
  <script>
    let video, canvas, ctx, stream, chart, currentImage;
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          currentImage = ev.target.result;
          preview.src = currentImage;
          preview.classList.remove('hidden');
          video.classList.add('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    function startCamera() {
      video = document.getElementById('video'); canvas = document.getElementById('canvas'); ctx = canvas.getContext('2d');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(s => { stream = s; video.srcObject = stream; video.play(); video.classList.remove('hidden'); preview.classList.add('hidden'); });
    }

    function scanImage() {
      let image;
      if (preview.src && !preview.classList.contains('hidden')) {
        image = preview.src;
      } else {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        image = canvas.toDataURL('image/jpeg');
      }
      Tesseract.recognize(image, 'eng+ind', { logger: m => console.log(m) })
        .then(({ data: { text } }) => {
          const name = findFood(text.toLowerCase());
          if (name) displayResult(makananDB[name]);
          else alert('Makanan tidak dikenali. Coba foto lebih jelas!');
        });
    }

    function findFood(text) {
      for (let key in makananDB) {
        if (text.includes(key)) return key;
      }
      return null;
    }

    function displayResult(food) {
      document.getElementById('food-name').textContent = food.name;
      document.getElementById('calories').textContent = food.cal;
      document.getElementById('carb').textContent = food.carb + 'g';
      document.getElementById('protein').textContent = food.prot + 'g';
      document.getElementById('fat').textContent = food.fat + 'g';
      document.getElementById('result').classList.remove('hidden');
      const ctxChart = document.getElementById('giziChart').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctxChart, {
        type: 'doughnut',
        data: { labels: ['Karbo', 'Protein', 'Lemak'], datasets: [{ data: [food.carb, food.prot, food.fat], backgroundColor: ['#51cf66', '#ffd43b', '#ff6b6b'] }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
    }

    function saveFood() {
      const name = document.getElementById('food-name').textContent;
      const cal = document.getElementById('calories').textContent;
      const history = JSON.parse(localStorage.getItem('rifqyKaloriHistory') || '[]');
      history.push({ name, cal, time: new Date().toLocaleString('id-ID') });
      localStorage.setItem('rifqyKaloriHistory', JSON.stringify(history));
      alert(`${name} disimpan!`);
      updateHistory();
    }

    function updateHistory() {
      const list = document.getElementById('history-list');
      const history = JSON.parse(localStorage.getItem('rifqyKaloriHistory') || '[]');
      list.innerHTML = '';
      history.slice(-10).reverse().forEach(h => {
        const div = document.createElement('div'); div.className = 'history-item';
        div.innerHTML = `<strong>${h.name}</strong> – ${h.cal} kcal<br><small>${h.time}</small>`;
        list.appendChild(div);
      });
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.getElementById(`tab-${tab}`).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === (tab === 'home' ? 0 : 1)));
      if (tab === 'riwayat') updateHistory();
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install",e=>self.skipWaiting());self.addEventListener("fetch",e=>e.respondWith(fetch(e.request)));');
    }
  </script>
</body>
  </html>
